const mongoose = require("mongoose");
const User = mongoose.model("users");
const Product = mongoose.model("products");

//This is my sandbox URI for mlab.com, feel free to use it
//You wont need access to the mlab.com in this case
mongoose.connect('mongodb://phillip:se133@ds261828.mlab.com:61828/grocery'); 

module.exports = app => {
  app.get("/api/test", async function(req, res) {
      
    //Generate random IDs
    let userID = (Math.floor((Math.random() * 1000) + 1)).toString();
    let productID = (Math.floor((Math.random() * 1000) + 1)).toString();
      
    //Add User to the database
    await new User({
        id: userID,
    }).save();

    //Add product to the Database
    const newProduct = await new Product({
        id: productID,
        addedBy: userID
    }).save();

    //Add product ID into Users 'addedItems' array
    const updatedUser = await User.findOneAndUpdate(
      { id: userID },
      { $push: { addedItems: newProduct.id } },
      { upsert: true, new: true },
      function(err, doc) {
        if(err){
            console.log(err);
        }
        
        //This will show only ONE entry inside of 'addedItems'
        console.log(doc);
        console.log("");
      }
    );
    
    //This will show TWO entries inside of 'addedItems'
    console.log(updatedUser);
  });
};
